<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitHub Issue æäº¤å·¥å…· - æœ¬åœ°æµ‹è¯•ç‰ˆ</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              // GitHub æ·±è‰²æ¨¡å¼å®˜æ–¹é…è‰²
              github: {
                primary: "#2f81f7", // GitHub æ·±è‰²ä¸»è“
                primaryDark: "#1f6feb", // ä¸»è“æ·±é˜¶ï¼ˆæ¸å˜ï¼‰
                secondary: "#3fb950", // GitHub æ·±è‰²ä¸»ç»¿
                secondaryDark: "#2ea043", // ç»¿è‰²æ·±é˜¶ï¼ˆæ¸å˜ï¼‰
                neutral: "#e6edf3", // ä¸»æ–‡æœ¬è‰²ï¼ˆæµ…ç™½ï¼‰
                neutralLight: "#8b949e", // æ¬¡è¦æ–‡æœ¬è‰²
                neutralUltraLight: "#6e7681", // è¶…æµ…æ–‡æœ¬è‰²
                bg: "#161b22", // å¡ç‰‡èƒŒæ™¯ï¼ˆGitHub æ·±è‰²å¡ç‰‡ï¼‰
                bgLight: "#0d1117", // body èƒŒæ™¯ï¼ˆGitHub æ·±è‰²å…¨å±€èƒŒæ™¯ï¼‰
                bgUltraLight: "#21262d", // ææµ…èƒŒæ™¯ï¼ˆhover/é«˜äº®ï¼‰
                border: "#30363d", // è¾¹æ¡†è‰²
                borderLight: "#21262d", // æµ…è¾¹æ¡†è‰²
                danger: "#f85149", // å±é™©/é”™è¯¯è‰²
                dangerLight: "#3b181c", // é”™è¯¯èƒŒæ™¯
                warning: "#e3b341", // è­¦å‘Šè‰²
                warningLight: "#342809", // è­¦å‘ŠèƒŒæ™¯
                info: "#3fb950", // ä¿¡æ¯è‰²
                infoLight: "#162317", // ä¿¡æ¯èƒŒæ™¯
                prompt: "#1f2937", // Promptä¾§è¾¹æ èƒŒæ™¯
              },
            },
            animation: {
              "spin-slow": "spin 1s ease-in-out infinite",
              "fade-in": "fadeIn 0.3s ease-in-out",
              "pulse-soft": "pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite",
              "slide-in-right": "slideInRight 0.3s ease-in-out",
              "slide-out-right": "slideOutRight 0.3s ease-in-out",
            },
            keyframes: {
              fadeIn: {
                "0%": { opacity: "0" },
                "100%": { opacity: "1" },
              },
              slideInRight: {
                "0%": { transform: "translateX(100%)" },
                "100%": { transform: "translateX(0)" },
              },
              slideOutRight: {
                "0%": { transform: "translateX(0)" },
                "100%": { transform: "translateX(100%)" },
              },
            },
            boxShadow: {
              github: "0 1px 3px rgba(0, 0, 0, 0.1)",
              "github-hover": "0 4px 6px rgba(0, 0, 0, 0.2)",
              "github-button": "0 1px 2px rgba(0, 0, 0, 0.2)",
              "prompt-sidebar": "0 0 20px rgba(0, 0, 0, 0.5)",
            },
          },
        },
      };
    </script>
    <style type="text/tailwindcss">
      @layer utilities {
        .content-auto {
          content-visibility: auto;
        }
        .file-item-enter {
          animation: fadeIn 0.3s ease-in-out;
        }
        .text-balance {
          text-wrap: balance;
        }
        /* æ¸å˜èƒŒæ™¯ç±» */
        .bg-gradient-github-primary {
          background: linear-gradient(
            135deg,
            theme("colors.github.primary"),
            theme("colors.github.primaryDark")
          );
        }
        .bg-gradient-github-secondary {
          background: linear-gradient(
            135deg,
            theme("colors.github.secondary"),
            theme("colors.github.secondaryDark")
          );
        }
        .bg-gradient-github-neutral {
          background: linear-gradient(
            135deg,
            theme("colors.github.neutralLight"),
            #484f58
          );
        }
        .bg-gradient-github-bg {
          background: linear-gradient(
            135deg,
            theme("colors.github.bg"),
            theme("colors.github.bgUltraLight")
          );
        }
        .border-gradient-github {
          border-image: linear-gradient(
              135deg,
              theme("colors.github.primary"),
              theme("colors.github.secondary")
            )
            1;
        }
        /* ä¾§è¾¹æ é®ç½© */
        .sidebar-overlay {
          backdrop-filter: blur(2px);
          background-color: rgba(0, 0, 0, 0.7);
        }
      }
    </style>
  </head>
  <!-- body èƒŒæ™¯ä¸º GitHub æ·±è‰²å…¨å±€èƒŒæ™¯ #0d1117 -->
  <body
    class="bg-github-bgLight text-github-neutral min-h-screen flex flex-col items-center p-4 sm:p-5"
  >
    <!-- Promptç¼–è¾‘ä¾§è¾¹æ ï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div
      id="promptSidebarOverlay"
      class="fixed inset-0 sidebar-overlay z-40 hidden"
    ></div>
    <div
      id="promptSidebar"
      class="fixed top-0 right-0 h-full w-full sm:w-[400px] md:w-[500px] bg-github-prompt border-l border-github-border shadow-prompt-sidebar z-50 transform translate-x-full transition-transform duration-300 flex flex-col"
    >
      <!-- ä¾§è¾¹æ å¤´éƒ¨ -->
      <div
        class="p-4 border-b border-github-border flex justify-between items-center bg-github-bg"
      >
        <h3 class="font-semibold text-lg flex items-center gap-2">
          <i class="fas fa-file-code text-github-primary"></i>
          ç¼–è¾‘ AI æç¤ºè¯ (prompt.txt)
        </h3>
        <button
          id="closePromptSidebar"
          class="p-2 rounded hover:bg-github-bgUltraLight transition-colors text-github-neutralLight"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- ä¾§è¾¹æ å†…å®¹ -->
      <div class="flex-1 overflow-auto p-4">
        <div class="mb-3">
          <label class="block text-sm text-github-neutralLight mb-1">
            æç¤ºè¯å†…å®¹ï¼ˆç”¨äºæŒ‡å¯¼AIè½¬æ¢Markdownï¼‰
          </label>
          <textarea
            id="promptEditor"
            class="w-full min-h-[300px] px-4 py-3 border border-github-border rounded-md font-mono text-sm bg-github-bgUltraLight text-white placeholder:text-github-neutralUltraLight focus:outline-none focus:border-github-primary focus:ring-2 focus:ring-github-primary/10"
            placeholder="è¯·è¾“å…¥AIæç¤ºè¯ï¼Œ{TITLE}ä¼šè‡ªåŠ¨æ›¿æ¢ä¸ºIssueæ ‡é¢˜..."
          ></textarea>
        </div>
        <div class="text-xs text-github-neutralUltraLight mb-4">
          <p class="mb-1">
            <i class="fas fa-info-circle text-github-primary"></i> å˜é‡è¯´æ˜ï¼š
          </p>
          <p>- {TITLE}ï¼šä¼šè‡ªåŠ¨æ›¿æ¢ä¸ºä½ è¾“å…¥çš„Issueæ ‡é¢˜</p>
          <p>- æç¤ºè¯å°†æŒ‡å¯¼AIå¦‚ä½•æ ¼å¼åŒ–å¯¼å…¥çš„æ–‡ä»¶å†…å®¹</p>
          <p class="mt-2 text-github-warning">
            âš ï¸ ä¿å­˜åä»…å½“å‰ä¼šè¯ç”Ÿæ•ˆï¼Œåˆ·æ–°é¡µé¢ä¼šæ¢å¤æœ¬åœ°prompt.txtå†…å®¹
          </p>
        </div>
      </div>

      <!-- ä¾§è¾¹æ åº•éƒ¨æŒ‰é’® -->
      <div
        class="p-4 border-t border-github-border bg-github-bg flex justify-between gap-3"
      >
        <button
          id="resetPromptBtn"
          class="px-4 py-2 bg-github-bgUltraLight text-github-neutral border border-github-border rounded-md font-medium hover:bg-github-bgUltraLight/80 transition-colors"
        >
          <i class="fas fa-undo mr-1"></i> é‡ç½®ä¸ºé»˜è®¤
        </button>
        <div class="flex gap-3">
          <button
            id="copyPromptBtn"
            class="px-4 py-2 bg-gradient-github-neutral text-white rounded-md font-medium hover:-translate-y-0.5 transition-all"
          >
            <i class="fas fa-copy mr-1"></i> å¤åˆ¶å†…å®¹
          </button>
          <button
            id="savePromptBtn"
            class="px-4 py-2 bg-gradient-github-primary text-white rounded-md font-medium hover:-translate-y-0.5 transition-all"
          >
            <i class="fas fa-save mr-1"></i> ä¿å­˜ä¿®æ”¹
          </button>
        </div>
      </div>
    </div>

    <!-- å¤´éƒ¨ - æ¸å˜èƒŒæ™¯å¢å¼º -->
    <header
      class="text-center mb-6 sm:mb-8 pb-4 sm:pb-5 border-b border-github-borderLight w-full max-w-[800px] bg-gradient-github-bg rounded-xl p-3 mb-8"
    >
      <h1
        class="text-github-neutral mb-2 sm:mb-3 flex items-center justify-center gap-3 md:flex-row flex-col md:text-[clamp(1.5rem,3vw,2rem)] text-[clamp(1.2rem,3vw,1.5rem)] font-bold"
      >
        <i class="fab fa-github text-2xl sm:text-3xl text-github-primary"></i>
        GitHub Issue æäº¤å·¥å…·
      </h1>
      <p class="text-github-neutralLight text-base sm:text-lg text-balance">
        å°†æœ¬åœ° TXT æ–‡ä»¶å†…å®¹è½¬æ¢ä¸º Markdown å¹¶æäº¤åˆ°æŒ‡å®š GitHub ä»“åº“
      </p>
    </header>

    <!-- ä¸»å®¹å™¨ - GitHub æ·±è‰²å¡ç‰‡é£æ ¼ + æ¸å˜ hover -->
    <div
      class="w-full max-w-[800px] bg-github-bg rounded-xl shadow-github p-5 sm:p-6 md:p-7 mt-2 transition-all duration-300 hover:shadow-github-hover hover:border border-github-border/50"
    >
      <!-- ç›®æ ‡ä»“åº“ + ç¼–è¾‘æç¤ºè¯æŒ‰é’® -->
      <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-5 sm:mb-6 gap-3"
      >
        <div
          class="bg-github-bgUltraLight p-4 rounded-lg border-l-4 border-github-primary bg-gradient-to-r from-github-primary/10 to-transparent w-full sm:w-auto flex-1"
        >
          <h3
            class="text-github-primary font-semibold mb-2 flex items-center gap-2"
          >
            <i class="fas fa-repository"></i> ç›®æ ‡ä»“åº“
          </h3>
          <p class="text-sm sm:text-base">
            æ‚¨çš„ Issue å°†è¢«æäº¤åˆ°:
            <a
              href="https://github.com/yuan-junxi/TaskEcho/issues"
              target="_blank"
              class="text-github-primary font-medium hover:underline inline-flex items-center gap-1 transition-colors"
            >
              <i class="fab fa-github text-xs"></i> yuan-junxi/TaskEcho
            </a>
          </p>
        </div>
        <!-- æ–°å¢ï¼šç¼–è¾‘æç¤ºè¯æŒ‰é’® -->
        <button
          id="editPromptBtn"
          class="px-4 py-2 bg-gradient-github-neutral text-white rounded-md font-semibold flex items-center justify-center gap-2 hover:-translate-y-0.5 hover:shadow-github-button transition-all duration-200 w-full sm:w-auto"
        >
          <i class="fas fa-file-code"></i> ç¼–è¾‘ AI æç¤ºè¯
        </button>
      </div>

      <!-- å®‰å…¨æç¤º - GitHub è­¦å‘Šè‰²é£æ ¼ -->
      <div
        class="bg-github-warningLight p-3 rounded-lg border-l-4 border-github-warning mb-5 sm:mb-6 text-sm animate-fade-in"
      >
        <div class="flex items-start gap-2">
          <strong class="text-github-warning flex-shrink-0">âš ï¸</strong>
          <p class="text-github-warning">
            æ­¤æ–‡ä»¶ä»…é™æœ¬åœ°æµ‹è¯•ä½¿ç”¨ï¼æ–‡ä»¶ä¸­åŒ…å«æ‚¨çš„ GitHub
            ä»¤ç‰Œï¼Œè¯·å‹¿ä¸Šä¼ æˆ–åˆ†äº«æ­¤æ–‡ä»¶ã€‚æµ‹è¯•åè¯·ç«‹å³æ’¤é”€æ­¤ä»¤ç‰Œã€‚
          </p>
        </div>
      </div>

      <!-- è¡¨å•åŒºåŸŸ -->
      <form id="issueForm" class="w-full">
        <!-- Issue æ ‡é¢˜ï¼ˆå‰ç½®ï¼‰- å­—ä½“ç™½è‰² -->
        <div class="mb-5 sm:mb-6">
          <label
            for="issueTitle"
            class="block mb-2 font-semibold text-github-neutral flex items-center gap-1"
          >
            <i class="fas fa-heading text-sm"></i> Issueæ ‡é¢˜
            <span class="text-github-danger">*</span>
          </label>
          <input
            type="text"
            id="issueTitle"
            placeholder="è¯·è¾“å…¥æ¸…æ™°ã€ç®€æ´çš„ Issue æ ‡é¢˜ï¼ˆå¦‚ï¼šä¿®å¤ç™»å½•é¡µé¢å…¼å®¹æ€§é—®é¢˜ï¼‰"
            required
            class="w-full px-4 py-3 border border-github-borderLight rounded-md text-base focus:outline-none focus:border-github-primary focus:ring-2 focus:ring-github-primary/10 transition-all duration-200 bg-github-bgUltraLight text-white shadow-sm placeholder:text-github-neutralUltraLight"
          />
          <div
            class="text-right text-sm text-github-neutralLight mt-1 flex justify-between items-center"
          >
            <span class="text-xs text-github-neutralUltraLight"
              >å»ºè®®é•¿åº¦ï¼š10-50 å­—ç¬¦</span
            >
            <span id="titleCharCount" class="font-mono">0</span> å­—ç¬¦
          </div>
        </div>

        <!-- æ–‡ä»¶æ‹–æ‹½/å¯¼å…¥åŒºåŸŸ - æ¸å˜ hover æ•ˆæœ -->
        <div
          id="dropArea"
          class="mb-5 sm:mb-6 border-2 border-dashed border-github-borderLight rounded-lg p-6 sm:p-8 text-center hover:border-github-primary hover:bg-github-bgUltraLight/80 transition-all duration-300 cursor-pointer group bg-gradient-to-br from-github-bg to-github-bgUltraLight/50"
        >
          <i
            class="fas fa-file-import text-3xl sm:text-4xl text-github-neutralLight mb-3 group-hover:text-github-primary transition-colors"
          ></i>
          <p class="text-github-neutralLight mb-4 text-balance">
            æ‹–æ‹½ TXT æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯¼å…¥
          </p>
          <!-- å¯¼å…¥æŒ‰é’® - GitHub ä¸­æ€§æ¸å˜ -->
          <button
            type="button"
            id="importTxtBtn"
            class="px-6 py-3 bg-gradient-github-neutral text-white rounded-md font-semibold flex items-center justify-center gap-2 mx-auto hover:-translate-y-0.5 hover:shadow-github-button transition-all duration-200 disabled:opacity-70 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none"
          >
            <i class="fas fa-file-import"></i> é€‰æ‹© TXT æ–‡ä»¶å¯¼å…¥
          </button>
          <input
            type="file"
            id="fileInput"
            class="hidden"
            accept=".txt,text/plain"
            multiple
          />

          <!-- å·²å¯¼å…¥æ–‡ä»¶åˆ—è¡¨ -->
          <div id="fileListContainer" class="mt-5 hidden">
            <h4
              class="text-sm font-semibold text-github-neutralLight mb-2 flex items-center gap-2"
            >
              <i class="fas fa-files-o"></i> å·²å¯¼å…¥æ–‡ä»¶ (<span id="fileCount"
                >0</span
              >)
            </h4>
            <div
              id="fileList"
              class="max-h-[200px] overflow-y-auto pr-2 space-y-2"
            ></div>
            <div
              class="mt-2 text-xs text-github-neutralUltraLight flex justify-between"
            >
              <span>æ€»å­—ç¬¦æ•°ï¼š<span id="totalFileChars">0</span></span>
              <span>æ€»å¤§å°ï¼š<span id="totalFileSize">0 B</span></span>
            </div>
          </div>
        </div>

        <!-- Markdown ç¼–è¾‘åŒºåŸŸ - é€‚é…æ·±è‰² -->
        <div class="mb-5 sm:mb-6">
          <label
            for="markdownOutput"
            class="block mb-2 font-semibold text-github-neutral flex items-center gap-1"
          >
            <i class="fab fa-markdown text-sm"></i> AI ç”Ÿæˆçš„ Markdown
            <span class="text-github-danger">*</span>
          </label>
          <div class="relative">
            <textarea
              id="markdownOutput"
              placeholder="å¯¼å…¥æ–‡ä»¶åï¼Œç‚¹å‡»ã€Œè½¬æ¢ä¸º Markdownã€æŒ‰é’®ç”Ÿæˆå†…å®¹ï¼Œå¯ç›´æ¥ç¼–è¾‘..."
              class="w-full min-h-[200px] sm:min-h-[250px] px-4 py-3 border border-github-borderLight rounded-md text-base resize-vertical focus:outline-none focus:border-github-primary focus:ring-2 focus:ring-github-primary/10 transition-all duration-200 font-mono text-sm bg-github-bgUltraLight text-white placeholder:text-github-neutralUltraLight readonly:bg-github-bgUltraLight/80 read-write:bg-github-bgUltraLight shadow-sm"
              readonly
            ></textarea>
            <!-- ç¼–è¾‘çŠ¶æ€æç¤º - GitHub ä¸»è‰²æ¸å˜ -->
            <div
              id="markdownEditHint"
              class="absolute top-2 right-2 text-xs px-2 py-1 rounded bg-gradient-github-primary text-white hidden"
            >
              <i class="fas fa-pencil-alt"></i> å¯ç¼–è¾‘
            </div>
          </div>
          <div
            class="text-right text-sm text-github-neutralLight mt-1 flex justify-between items-center"
          >
            <span class="text-xs text-github-neutralUltraLight"
              >å»ºè®®é•¿åº¦ï¼š50-2000 å­—ç¬¦</span
            >
            <span id="markdownCharCount" class="font-mono">0</span> å­—ç¬¦
          </div>
        </div>

        <!-- æŒ‰é’®ç»„ -->
        <div
          class="flex flex-col md:flex-row justify-between gap-3 sm:gap-4 mt-4"
        >
          <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
            <!-- æ¸…ç©ºæŒ‰é’® - GitHub ææµ…èƒŒæ™¯ -->
            <button
              type="button"
              id="clearBtn"
              class="px-6 py-3 bg-github-bgUltraLight text-github-neutral border border-github-borderLight rounded-md font-semibold flex items-center justify-center gap-2 hover:bg-github-bgUltraLight/80 hover:-translate-y-0.5 hover:shadow-github-button transition-all duration-200 w-full sm:w-auto"
            >
              <i class="fas fa-eraser"></i> æ¸…ç©ºæ‰€æœ‰å†…å®¹
            </button>
            <!-- è½¬æ¢æŒ‰é’® - GitHub ä¸»è‰²æ¸å˜ -->
            <button
              type="button"
              id="convertBtn"
              class="px-6 py-3 bg-gradient-github-primary text-white rounded-md font-semibold flex items-center justify-center gap-2 hover:-translate-y-0.5 hover:shadow-github-button transition-all duration-200 disabled:opacity-70 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none w-full sm:w-auto"
            >
              <i class="fas fa-robot"></i> è½¬æ¢ä¸º Markdown
            </button>
          </div>
          <!-- æäº¤æŒ‰é’® - GitHub ç»¿è‰²æ¸å˜ -->
          <button
            type="submit"
            id="submitBtn"
            class="px-6 py-3 bg-gradient-github-secondary text-white rounded-md font-semibold flex items-center justify-center gap-2 hover:-translate-y-0.5 hover:shadow-github-button transition-all duration-200 disabled:opacity-70 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none w-full md:w-auto"
          >
            <i class="fas fa-paper-plane"></i> æäº¤ Issue åˆ° GitHub
          </button>
        </div>
      </form>

      <!-- çŠ¶æ€æç¤º - æ¸å˜èƒŒæ™¯åŒºåˆ†ç±»å‹ -->
      <div
        id="statusMessage"
        class="mt-5 p-4 rounded-md flex items-center gap-3 hidden animate-fade-in"
      >
        <i class="fas fa-info-circle text-lg status-icon flex-shrink-0"></i>
        <span id="statusText" class="text-balance">çŠ¶æ€ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</span>
      </div>
    </div>

    <!-- é¡µè„š - GitHub æ·±è‰²é£æ ¼ -->
    <footer
      class="mt-8 text-center text-github-neutralLight text-sm pt-5 border-t border-github-borderLight w-full max-w-[800px] bg-github-bg rounded-xl p-3"
    >
      <div
        class="flex flex-col sm:flex-row justify-center items-center gap-2 text-xs sm:text-sm"
      >
        <p>Â© 2025 GitHub Issue æäº¤å·¥å…·</p>
        <span class="hidden sm:inline">|</span>
        <p>åŸºäº GitHub REST API & AI é©±åŠ¨</p>
        <span class="hidden sm:inline">|</span>
        <p>ä»…é™æœ¬åœ°æµ‹è¯•ä½¿ç”¨</p>
      </div>
    </footer>

    <script>
      // DOM å…ƒç´ è·å–
      const issueForm = document.getElementById("issueForm");
      const issueTitle = document.getElementById("issueTitle");
      const markdownOutput = document.getElementById("markdownOutput");
      const submitBtn = document.getElementById("submitBtn");
      const convertBtn = document.getElementById("convertBtn");
      const clearBtn = document.getElementById("clearBtn");
      const importTxtBtn = document.getElementById("importTxtBtn");
      const fileInput = document.getElementById("fileInput");
      const dropArea = document.getElementById("dropArea");
      const statusMessage = document.getElementById("statusMessage");
      const statusText = document.getElementById("statusText");
      const titleCharCount = document.getElementById("titleCharCount");
      const markdownCharCount = document.getElementById("markdownCharCount");
      const statusIcon = statusMessage.querySelector(".status-icon");
      const fileListContainer = document.getElementById("fileListContainer");
      const fileList = document.getElementById("fileList");
      const fileCount = document.getElementById("fileCount");
      const totalFileChars = document.getElementById("totalFileChars");
      const totalFileSize = document.getElementById("totalFileSize");
      const markdownEditHint = document.getElementById("markdownEditHint");

      // Promptä¾§è¾¹æ ç›¸å…³å…ƒç´ 
      const editPromptBtn = document.getElementById("editPromptBtn");
      const promptSidebar = document.getElementById("promptSidebar");
      const promptSidebarOverlay = document.getElementById(
        "promptSidebarOverlay"
      );
      const closePromptSidebar = document.getElementById("closePromptSidebar");
      const promptEditor = document.getElementById("promptEditor");
      const savePromptBtn = document.getElementById("savePromptBtn");
      const resetPromptBtn = document.getElementById("resetPromptBtn");
      const copyPromptBtn = document.getElementById("copyPromptBtn");

      // é…ç½®å˜é‡
      let AI_CONFIG = {
        BASE_URL: "",
        API_KEY: "",
        MODEL: "",
        PROMPT_FILE: "prompt.txt",
        PROMPT_CONTENT: "",
        ORIGINAL_PROMPT: "", // ä¿å­˜åŸå§‹promptç”¨äºé‡ç½®
        IS_CONFIGURED: false,
      };

      let GITHUB_CONFIG = {
        TOKEN: "",
        REPO_OWNER: "yuan-junxi",
        REPO_NAME: "TaskEcho",
        API_URL: "https://api.github.com",
        IS_CONFIGURED: false,
      };

      // å­˜å‚¨å¯¼å…¥çš„æ–‡ä»¶ä¿¡æ¯
      let importedFiles = [];
      let importedContent = ""; // æ¢å¤æ–‡ä»¶å†…å®¹å­˜å‚¨å˜é‡

      // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // æ›´æ–°æ–‡ä»¶åˆ—è¡¨å±•ç¤º
      function updateFileList() {
        if (importedFiles.length === 0) {
          fileListContainer.classList.add("hidden");
          fileCount.textContent = "0";
          totalFileChars.textContent = "0";
          totalFileSize.textContent = "0 B";
          return;
        }

        // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨å®¹å™¨
        fileListContainer.classList.remove("hidden");

        // æ¸…ç©ºç°æœ‰åˆ—è¡¨
        fileList.innerHTML = "";

        // è®¡ç®—æ€»æ•°
        const totalChars = importedFiles.reduce(
          (sum, file) => sum + file.content.length,
          0
        );
        const totalSize = importedFiles.reduce(
          (sum, file) => sum + file.size,
          0
        );

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        fileCount.textContent = importedFiles.length;
        totalFileChars.textContent = totalChars;
        totalFileSize.textContent = formatFileSize(totalSize);

        // ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨é¡¹ï¼ˆGitHub æ·±è‰²é£æ ¼ï¼‰
        importedFiles.forEach((file, index) => {
          const fileItem = document.createElement("div");
          fileItem.className =
            "flex items-center justify-between p-2 bg-github-bgUltraLight/50 rounded border border-github-borderLight hover:bg-github-bgUltraLight hover:border-github-primary/30 transition-colors file-item-enter";
          fileItem.innerHTML = `
                  <div class="flex items-center gap-2 truncate">
                      <i class="fas fa-file-alt text-github-neutralLight flex-shrink-0"></i>
                      <div class="truncate">
                          <span class="font-medium truncate text-github-neutral">${
                            file.name
                          }</span>
                          <span class="text-xs text-github-neutralUltraLight ml-2">${formatFileSize(
                            file.size
                          )} / ${file.content.length} å­—ç¬¦</span>
                      </div>
                  </div>
                  <button type="button" data-index="${index}" class="text-github-danger hover:text-github-danger/80 transition-colors flex-shrink-0 p-1 rounded hover:bg-github-danger/5">
                      <i class="fas fa-times"></i>
                  </button>
              `;

          // åˆ é™¤æ–‡ä»¶äº‹ä»¶
          const deleteBtn = fileItem.querySelector("button");
          deleteBtn.addEventListener("click", () => {
            removeFile(index);
          });

          fileList.appendChild(fileItem);
        });
      }

      // ç§»é™¤å•ä¸ªæ–‡ä»¶
      function removeFile(index) {
        const removedFile = importedFiles[index];
        importedFiles.splice(index, 1);

        // é‡æ–°ç”Ÿæˆå¯¼å…¥å†…å®¹
        importedContent = importedFiles
          .map((file) => `\n\n=== æ–‡ä»¶ ${file.name} ===\n\n${file.content}`)
          .join("")
          .trim();

        // æ›´æ–°æ–‡ä»¶åˆ—è¡¨
        updateFileList();
        // æç¤º
        showStatusMessage(`å·²ç§»é™¤æ–‡ä»¶: ${removedFile.name}`, "info");
      }

      // åˆå§‹åŒ– UI äº‹ä»¶
      function initUIEvents() {
        // æ ‡é¢˜å­—ç¬¦è®¡æ•°æ›´æ–°
        issueTitle.addEventListener("input", () => {
          titleCharCount.textContent = issueTitle.value.length;
          // æ ‡é¢˜é•¿åº¦è¶…é™æç¤º
          if (issueTitle.value.length > 70) {
            titleCharCount.classList.add("text-github-danger");
          } else {
            titleCharCount.classList.remove("text-github-danger");
          }
        });

        markdownOutput.addEventListener("input", () => {
          markdownCharCount.textContent = markdownOutput.value.length;
        });

        // æ–‡ä»¶å¯¼å…¥æŒ‰é’®ç‚¹å‡»
        importTxtBtn.addEventListener("click", () => {
          fileInput.click();
        });

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        fileInput.addEventListener("change", async (e) => {
          const files = e.target.files;
          if (files.length === 0) return;
          await processTxtFiles(files);
        });

        // æ‹–æ‹½åŠŸèƒ½
        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          dropArea.addEventListener(eventName, preventDefaults, false);
        });

        // æ‹–æ‹½é«˜äº®
        ["dragenter", "dragover"].forEach((eventName) => {
          dropArea.addEventListener(
            eventName,
            () => {
              dropArea.classList.add(
                "border-github-primary",
                "bg-github-bgUltraLight"
              );
            },
            false
          );
        });

        ["dragleave", "drop"].forEach((eventName) => {
          dropArea.addEventListener(
            eventName,
            () => {
              dropArea.classList.remove(
                "border-github-primary",
                "bg-github-bgUltraLight"
              );
            },
            false
          );
        });

        // æ‹–æ‹½æ–‡ä»¶æ”¾ä¸‹å¤„ç†
        dropArea.addEventListener(
          "drop",
          async (e) => {
            const files = e.dataTransfer.files;
            if (files.length === 0) return;
            await processTxtFiles(files);
          },
          false
        );

        // æ¸…ç©ºæŒ‰é’®
        clearBtn.addEventListener("click", () => {
          issueTitle.value = "";
          markdownOutput.value = "";
          importedFiles = [];
          importedContent = ""; // æ¸…ç©ºå¯¼å…¥å†…å®¹
          titleCharCount.textContent = "0";
          markdownCharCount.textContent = "0";
          markdownOutput.readOnly = true;
          markdownEditHint.classList.add("hidden");
          hideStatusMessage();
          updateFileList(); // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
          titleCharCount.classList.remove("text-github-danger");
        });

        // è½¬æ¢ Markdown
        convertBtn.addEventListener("click", async () => {
          await convertToMarkdown();
        });

        // æäº¤ Issue
        issueForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          await submitIssue();
        });

        // Promptä¾§è¾¹æ äº‹ä»¶
        initPromptSidebarEvents();
      }

      // åˆå§‹åŒ–Promptä¾§è¾¹æ äº‹ä»¶
      function initPromptSidebarEvents() {
        // æ‰“å¼€ä¾§è¾¹æ 
        editPromptBtn.addEventListener("click", () => {
          promptSidebarOverlay.classList.remove("hidden");
          promptSidebar.classList.remove("translate-x-full");
          // å¡«å……å½“å‰promptå†…å®¹
          promptEditor.value = AI_CONFIG.PROMPT_CONTENT;
          document.body.style.overflow = "hidden"; // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
        });

        // å…³é—­ä¾§è¾¹æ 
        function closeSidebar() {
          promptSidebarOverlay.classList.add("hidden");
          promptSidebar.classList.add("translate-x-full");
          document.body.style.overflow = ""; // æ¢å¤æ»šåŠ¨
        }

        closePromptSidebar.addEventListener("click", closeSidebar);
        promptSidebarOverlay.addEventListener("click", closeSidebar);

        // ä¿å­˜Promptä¿®æ”¹
        savePromptBtn.addEventListener("click", () => {
          const newPrompt = promptEditor.value.trim();
          if (!newPrompt) {
            showStatusMessage("æç¤ºè¯å†…å®¹ä¸èƒ½ä¸ºç©º", "error");
            return;
          }
          AI_CONFIG.PROMPT_CONTENT = newPrompt;
          showStatusMessage("âœ… æç¤ºè¯ä¿®æ”¹å·²ä¿å­˜ï¼ˆå½“å‰ä¼šè¯ç”Ÿæ•ˆï¼‰", "success");
          closeSidebar();
        });

        // é‡ç½®Promptä¸ºåŸå§‹å†…å®¹
        resetPromptBtn.addEventListener("click", () => {
          if (AI_CONFIG.ORIGINAL_PROMPT) {
            promptEditor.value = AI_CONFIG.ORIGINAL_PROMPT;
            showStatusMessage("å·²é‡ç½®ä¸ºåŸå§‹æç¤ºè¯å†…å®¹", "info");
          } else {
            showStatusMessage("æš‚æ— åŸå§‹æç¤ºè¯å¯é‡ç½®", "warning");
          }
        });

        // å¤åˆ¶Promptå†…å®¹
        copyPromptBtn.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(promptEditor.value);
            showStatusMessage("âœ… æç¤ºè¯å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", "success");
          } catch (error) {
            showStatusMessage("âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶", "error");
          }
        });
      }

      // é˜»æ­¢é»˜è®¤æ‹–æ‹½è¡Œä¸º
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      // åˆå§‹åŒ–å­—ç¬¦è®¡æ•°
      function initCharCounts() {
        titleCharCount.textContent = issueTitle.value.length;
        markdownCharCount.textContent = markdownOutput.value.length;
      }

      // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
      function showStatusMessage(message, type) {
        statusText.textContent = message;
        // é‡ç½®æ ·å¼
        statusMessage.className =
          "mt-5 p-4 rounded-md flex items-center gap-3 animate-fade-in";
        statusIcon.className = "fas text-lg status-icon flex-shrink-0";

        switch (type) {
          case "success":
            statusMessage.classList.add(
              "bg-gradient-to-r",
              "from-github-secondary/10",
              "to-github-secondary/5",
              "text-github-secondary",
              "border",
              "border-github-secondary/20"
            );
            statusIcon.classList.add(
              "fa-check-circle",
              "text-github-secondary"
            );
            break;
          case "error":
            statusMessage.classList.add(
              "bg-gradient-to-r",
              "from-github-dangerLight",
              "to-github-dangerLight/80",
              "text-github-danger",
              "border",
              "border-github-danger/20"
            );
            statusIcon.classList.add(
              "fa-exclamation-circle",
              "text-github-danger"
            );
            break;
          case "info":
            statusMessage.classList.add(
              "bg-gradient-to-r",
              "from-github-infoLight",
              "to-github-infoLight/80",
              "text-github-info",
              "border",
              "border-github-info/20"
            );
            statusIcon.classList.add("fa-info-circle", "text-github-info");
            break;
          case "warning":
            statusMessage.classList.add(
              "bg-gradient-to-r",
              "from-github-warningLight",
              "to-github-warningLight/80",
              "text-github-warning",
              "border",
              "border-github-warning/20"
            );
            statusIcon.classList.add(
              "fa-exclamation-triangle",
              "text-github-warning"
            );
            break;
        }
        statusMessage.style.display = "flex";

        // 5ç§’åè‡ªåŠ¨éšè—éé”™è¯¯ç±»æç¤º
        if (type !== "error") {
          setTimeout(() => {
            hideStatusMessage();
          }, 5000);
        }
      }

      // éšè—çŠ¶æ€æ¶ˆæ¯
      function hideStatusMessage() {
        statusMessage.style.display = "none";
      }

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      function updateButtonState(converting = false, submitting = false) {
        convertBtn.disabled = converting || submitting;
        submitBtn.disabled = submitting || converting;
        importTxtBtn.disabled = converting || submitting;

        if (converting) {
          convertBtn.innerHTML =
            '<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin-slow"></div> è½¬æ¢ä¸­...';
        } else {
          convertBtn.innerHTML = '<i class="fas fa-robot"></i> è½¬æ¢ä¸º Markdown';
        }

        if (submitting) {
          submitBtn.innerHTML =
            '<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin-slow"></div> æäº¤ä¸­...';
        } else {
          submitBtn.innerHTML =
            '<i class="fas fa-paper-plane"></i> æäº¤ Issue åˆ° GitHub';
        }

        if (converting || submitting) {
          importTxtBtn.innerHTML =
            '<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin-slow"></div> å¤„ç†ä¸­...';
        } else if (importTxtBtn.disabled) {
          importTxtBtn.innerHTML =
            '<i class="fas fa-file-import"></i> é€‰æ‹© TXT æ–‡ä»¶å¯¼å…¥';
        }
      }

      // éªŒè¯è¡¨å•
      function validateForm() {
        if (!issueTitle.value.trim()) {
          showStatusMessage("è¯·å¡«å†™ Issue æ ‡é¢˜", "error");
          issueTitle.focus();
          return false;
        }

        if (issueTitle.value.length > 100) {
          showStatusMessage("Issue æ ‡é¢˜è¿‡é•¿ï¼ˆå»ºè®®ä¸è¶…è¿‡ 100 å­—ç¬¦ï¼‰", "error");
          issueTitle.focus();
          return false;
        }

        if (!importedContent.trim()) {
          showStatusMessage("è¯·å…ˆå¯¼å…¥ TXT æ–‡ä»¶", "error");
          importTxtBtn.focus();
          return false;
        }

        if (!markdownOutput.value.trim()) {
          showStatusMessage("è¯·å…ˆè½¬æ¢ Markdown å†…å®¹", "error");
          convertBtn.focus();
          return false;
        }

        return true;
      }

      // åŠ è½½æç¤ºè¯æ–‡ä»¶
      async function loadPromptFile() {
        try {
          const response = await fetch(AI_CONFIG.PROMPT_FILE);
          if (!response.ok) {
            console.warn(
              `æç¤ºè¯æ–‡ä»¶åŠ è½½å¤±è´¥: ${response.status}ï¼Œä½¿ç”¨å†…ç½®æç¤ºè¯`
            );
            AI_CONFIG.PROMPT_CONTENT = `è¯·å°†ä»¥ä¸‹ç”¨æˆ·è¾“å…¥çš„å†…å®¹ï¼Œç»“åˆæ ‡é¢˜ã€Œ{TITLE}ã€ä¼˜åŒ–å¹¶æ ¼å¼åŒ–ä¸ºä¸€ä¸ªç»“æ„æ¸…æ™°ã€é€‚åˆä½œä¸º GitHub Issue æè¿°çš„ Markdown æ–‡æœ¬ã€‚è¦æ±‚ï¼š
1. ä¿æŒåŸæ„ä¸å˜ï¼Œä¼˜åŒ–è¯­è¨€è¡¨è¾¾
2. ä½¿ç”¨åˆé€‚çš„ Markdown æ ¼å¼ï¼ˆå¦‚æ ‡é¢˜ã€åˆ—è¡¨ã€ä»£ç å—ç­‰ï¼‰
3. å¦‚æœå†…å®¹æ¶‰åŠé—®é¢˜æè¿°ï¼Œè¯·ç»“æ„åŒ–ç»„ç»‡ï¼ˆå¦‚ï¼šé—®é¢˜æè¿°ã€å¤ç°æ­¥éª¤ã€é¢„æœŸç»“æœã€å®é™…ç»“æœï¼‰
4. è¾“å‡ºè¯­è¨€ä¸è¾“å…¥è¯­è¨€ä¿æŒä¸€è‡´
5. ç§»é™¤æ— å…³çš„æ–‡ä»¶æ ‡è¯†ä¿¡æ¯ï¼Œåªä¿ç•™æ ¸å¿ƒå†…å®¹

ç”¨æˆ·è¾“å…¥å†…å®¹ï¼š`;
            AI_CONFIG.ORIGINAL_PROMPT = AI_CONFIG.PROMPT_CONTENT; // ä¿å­˜åŸå§‹å†…å®¹
            return true;
          }

          const promptText = await response.text();
          if (!promptText.trim()) {
            throw new Error("æç¤ºè¯æ–‡ä»¶ä¸ºç©º");
          }

          AI_CONFIG.PROMPT_CONTENT = promptText;
          AI_CONFIG.ORIGINAL_PROMPT = promptText; // ä¿å­˜åŸå§‹å†…å®¹
          console.log("æç¤ºè¯æ–‡ä»¶åŠ è½½æˆåŠŸï¼Œé•¿åº¦:", promptText.length);
          return true;
        } catch (error) {
          console.error("åŠ è½½æç¤ºè¯æ–‡ä»¶å¤±è´¥:", error);
          AI_CONFIG.PROMPT_CONTENT = `è¯·å°†ä»¥ä¸‹æ–‡æœ¬ç»“åˆæ ‡é¢˜ã€Œ{TITLE}ã€è½¬æ¢ä¸ºæ ¼å¼è‰¯å¥½çš„ GitHub Issue Markdown æè¿°ï¼š

ç”¨æˆ·è¾“å…¥ï¼š`;
          AI_CONFIG.ORIGINAL_PROMPT = AI_CONFIG.PROMPT_CONTENT; // ä¿å­˜åŸå§‹å†…å®¹
          return true;
        }
      }

      // æ„å»ºå®Œæ•´æç¤ºè¯
      function buildFullPrompt() {
        const title = issueTitle.value.trim();
        const content = importedContent; // ä»å¯¼å…¥å†…å®¹è·å–
        let fullPrompt = AI_CONFIG.PROMPT_CONTENT.replace("{TITLE}", title);
        if (!fullPrompt.endsWith("\n")) {
          fullPrompt += "\n";
        }
        if (
          !fullPrompt.includes("ç”¨æˆ·è¾“å…¥ï¼š") &&
          !fullPrompt.includes("User Input:")
        ) {
          fullPrompt += "\n---\nç”¨æˆ·è¾“å…¥ï¼š\n";
        }
        fullPrompt += content;
        return fullPrompt;
      }

      // æ£€æµ‹ API æä¾›å•†ç±»å‹
      function detectAPIProvider(baseUrl) {
        const url = baseUrl.toLowerCase();
        const providerPatterns = [
          { pattern: "openai|api.openai.com", provider: "openai" },
          { pattern: "anthropic|api.anthropic.com", provider: "anthropic" },
          { pattern: "deepseek|api.deepseek.com", provider: "deepseek" },
          { pattern: "ollama|localhost|127.0.0.1", provider: "ollama" },
          { pattern: "groq|api.groq.com", provider: "groq" },
          { pattern: "zhipu|open.bigmodel.cn", provider: "zhipu" },
          { pattern: "qwen|dashscope.aliyuncs.com", provider: "qwen" },
          { pattern: "azure|openai.azure.com", provider: "azure" },
        ];

        for (const { pattern, provider } of providerPatterns) {
          if (new RegExp(pattern).test(url)) {
            return provider;
          }
        }
        return "openai-compatible";
      }

      // æ„å»º AI è¯·æ±‚å‚æ•°
      function buildAIRequest(provider, fullPrompt) {
        const commonParams = {
          model: AI_CONFIG.MODEL,
          max_tokens: 4000,
          temperature: 0.3,
        };

        switch (provider) {
          case "openai":
          case "deepseek":
          case "groq":
          case "azure":
          case "openai-compatible":
          case "zhipu":
            return {
              url: `${AI_CONFIG.BASE_URL}/chat/completions`,
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${AI_CONFIG.API_KEY}`,
              },
              body: JSON.stringify({
                ...commonParams,
                messages: [
                  {
                    role: "system",
                    content:
                      "ä½ æ˜¯ä¸€åä¸“ä¸šçš„ Markdown æ ¼å¼åŒ–åŠ©æ‰‹ï¼Œä¸“æ³¨äºå°†æ–‡æœ¬è½¬æ¢ä¸ºç»“æ„è‰¯å¥½çš„ GitHub Issue æè¿°ã€‚",
                  },
                  { role: "user", content: fullPrompt },
                ],
                stream: false,
              }),
            };

          case "anthropic":
            return {
              url: `${AI_CONFIG.BASE_URL}/v1/messages`,
              headers: {
                "Content-Type": "application/json",
                "x-api-key": AI_CONFIG.API_KEY,
                "anthropic-version": "2023-06-01",
              },
              body: JSON.stringify({
                model: AI_CONFIG.MODEL,
                max_tokens: 4000,
                messages: [{ role: "user", content: fullPrompt }],
                system:
                  "ä½ æ˜¯ä¸€åä¸“ä¸šçš„ Markdown æ ¼å¼åŒ–åŠ©æ‰‹ï¼Œä¸“æ³¨äºå°†æ–‡æœ¬è½¬æ¢ä¸ºç»“æ„è‰¯å¥½çš„ GitHub Issue æè¿°ã€‚",
              }),
            };

          case "ollama":
            return {
              url: `${AI_CONFIG.BASE_URL}/api/chat`,
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                model: AI_CONFIG.MODEL,
                messages: [
                  {
                    role: "system",
                    content:
                      "ä½ æ˜¯ä¸€åä¸“ä¸šçš„ Markdown æ ¼å¼åŒ–åŠ©æ‰‹ï¼Œä¸“æ³¨äºå°†æ–‡æœ¬è½¬æ¢ä¸ºç»“æ„è‰¯å¥½çš„ GitHub Issue æè¿°ã€‚",
                  },
                  { role: "user", content: fullPrompt },
                ],
                stream: false,
                options: {
                  temperature: 0.3,
                  num_predict: 4000,
                },
              }),
            };

          case "qwen":
            return {
              url: `${AI_CONFIG.BASE_URL}/api/v1/services/aigc/text-generation/generation`,
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${AI_CONFIG.API_KEY}`,
              },
              body: JSON.stringify({
                model: AI_CONFIG.MODEL,
                input: {
                  messages: [
                    {
                      role: "system",
                      content:
                        "ä½ æ˜¯ä¸€åä¸“ä¸šçš„ Markdown æ ¼å¼åŒ–åŠ©æ‰‹ï¼Œä¸“æ³¨äºå°†æ–‡æœ¬è½¬æ¢ä¸ºç»“æ„è‰¯å¥½çš„ GitHub Issue æè¿°ã€‚",
                    },
                    { role: "user", content: fullPrompt },
                  ],
                },
                parameters: {
                  temperature: 0.3,
                  max_tokens: 4000,
                },
              }),
            };

          default:
            return {
              url: `${AI_CONFIG.BASE_URL}/chat/completions`,
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${AI_CONFIG.API_KEY}`,
              },
              body: JSON.stringify({
                ...commonParams,
                messages: [
                  {
                    role: "system",
                    content:
                      "ä½ æ˜¯ä¸€åä¸“ä¸šçš„ Markdown æ ¼å¼åŒ–åŠ©æ‰‹ï¼Œä¸“æ³¨äºå°†æ–‡æœ¬è½¬æ¢ä¸ºç»“æ„è‰¯å¥½çš„ GitHub Issue æè¿°ã€‚",
                  },
                  { role: "user", content: fullPrompt },
                ],
                stream: false,
              }),
            };
        }
      }

      // è§£æ AI å“åº”
      function parseAIResponse(provider, data) {
        try {
          let content = "";
          switch (provider) {
            case "openai":
            case "deepseek":
            case "groq":
            case "azure":
            case "openai-compatible":
            case "zhipu":
              content = data.choices[0]?.message?.content || "";
              break;
            case "anthropic":
              content = data.content[0]?.text || "";
              break;
            case "ollama":
              content = data.message?.content || "";
              break;
            case "qwen":
              content =
                data.output?.text ||
                data.output?.choices?.[0]?.message?.content ||
                "";
              break;
            default:
              if (data.choices && data.choices[0]?.message?.content) {
                content = data.choices[0].message.content;
              } else if (data.content) {
                content = data.content;
              } else if (data.message) {
                content = data.message.content || data.message;
              } else if (data.output) {
                content = data.output.text || JSON.stringify(data.output);
              }
          }

          content = content.trim();
          const unwantedPrefixes = [
            "å¥½çš„ï¼Œ",
            "ä»¥ä¸‹æ˜¯",
            "æ ¹æ®æ‚¨çš„è¦æ±‚",
            "æ ¹æ®ç”¨æˆ·è¾“å…¥",
            "è½¬æ¢åçš„Markdownå¦‚ä¸‹ï¼š",
            "Markdownæ ¼å¼ï¼š",
            "æˆ‘å°†ä¸ºæ‚¨è½¬æ¢ï¼š",
          ];
          for (const prefix of unwantedPrefixes) {
            if (content.startsWith(prefix)) {
              content = content.substring(prefix.length).trim();
            }
          }
          return content;
        } catch (error) {
          console.error("è§£æ AI å“åº”å¤±è´¥:", error, data);
          return "";
        }
      }

      // è½¬æ¢ä¸º Markdown
      async function convertToMarkdown() {
        const title = issueTitle.value.trim();

        if (!AI_CONFIG.IS_CONFIGURED) {
          showStatusMessage("âŒ AI é…ç½®æœªåŠ è½½å®Œæˆ", "error");
          return;
        }

        if (!title) {
          showStatusMessage("è¯·å…ˆå¡«å†™ Issue æ ‡é¢˜", "error");
          issueTitle.focus();
          return;
        }

        if (!importedContent.trim()) {
          showStatusMessage("è¯·å…ˆå¯¼å…¥ TXT æ–‡ä»¶", "error");
          importTxtBtn.focus();
          return;
        }

        updateButtonState(true, false);
        showStatusMessage(
          `ğŸ¤– æ­£åœ¨ä½¿ç”¨ ${AI_CONFIG.MODEL} è½¬æ¢ Markdown...`,
          "info"
        );

        try {
          const fullPrompt = buildFullPrompt();
          const provider = detectAPIProvider(AI_CONFIG.BASE_URL);
          const requestConfig = buildAIRequest(provider, fullPrompt);

          const response = await fetch(requestConfig.url, {
            method: "POST",
            headers: requestConfig.headers,
            body: requestConfig.body,
          });

          if (!response.ok) {
            let errorMessage = `AI API é”™è¯¯ (${response.status})`;
            try {
              const errorData = await response.json();
              errorMessage += `: ${
                errorData.error?.message || JSON.stringify(errorData)
              }`;
            } catch (e) {
              errorMessage += `: ${response.statusText}`;
            }
            throw new Error(errorMessage);
          }

          const data = await response.json();
          const formattedText = parseAIResponse(provider, data);

          if (!formattedText.trim()) {
            throw new Error("AI è¿”å›å†…å®¹ä¸ºç©º");
          }

          // å¡«å…¥å¹¶å…è®¸ç¼–è¾‘
          markdownOutput.value = formattedText;
          markdownOutput.readOnly = false;
          markdownEditHint.classList.remove("hidden");
          markdownCharCount.textContent = formattedText.length;
          showStatusMessage(
            `âœ… ${AI_CONFIG.MODEL} è½¬æ¢å®Œæˆï¼å¯ä»¥ç¼–è¾‘ Markdown å†…å®¹`,
            "success"
          );
        } catch (error) {
          console.error("AI è½¬æ¢å¤±è´¥:", error);
          showStatusMessage(`âš ï¸ AI è½¬æ¢å¤±è´¥: ${error.message}`, "error");
        } finally {
          updateButtonState(false, false);
        }
      }

      // æäº¤ Issue åˆ° GitHub
      async function submitIssue() {
        if (!GITHUB_CONFIG.IS_CONFIGURED) {
          showStatusMessage("âŒ GitHub é…ç½®æœªåŠ è½½å®Œæˆ", "error");
          return;
        }

        if (!validateForm()) {
          return;
        }

        const title = issueTitle.value.trim();
        const body = markdownOutput.value.trim();

        updateButtonState(false, true);
        showStatusMessage("ğŸš€ æ­£åœ¨æäº¤ Issue åˆ° GitHub...", "info");

        try {
          const apiUrl = `${GITHUB_CONFIG.API_URL}/repos/${GITHUB_CONFIG.REPO_OWNER}/${GITHUB_CONFIG.REPO_NAME}/issues`;
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              Authorization: `token ${GITHUB_CONFIG.TOKEN}`,
              "Content-Type": "application/json",
              Accept: "application/vnd.github.v3+json",
            },
            body: JSON.stringify({
              title: title,
              body: body,
            }),
          });

          const responseData = await response.json();

          if (response.ok) {
            showStatusMessage(
              `âœ… Issue #${responseData.number} åˆ›å»ºæˆåŠŸï¼å³å°†æ‰“å¼€ Issue é¡µé¢`,
              "success"
            );
            // æ¸…ç©ºæ‰€æœ‰å†…å®¹
            issueTitle.value = "";
            markdownOutput.value = "";
            markdownOutput.readOnly = true;
            markdownEditHint.classList.add("hidden");
            importedFiles = [];
            importedContent = "";
            titleCharCount.textContent = "0";
            markdownCharCount.textContent = "0";
            updateFileList();

            setTimeout(() => {
              if (responseData.html_url) {
                window.open(responseData.html_url, "_blank");
              }
            }, 1500);
          } else {
            let errorMessage = `GitHub æäº¤å¤±è´¥ (${response.status})`;
            if (response.status === 401)
              errorMessage = "GitHub è®¤è¯å¤±è´¥ï¼ˆä»¤ç‰Œæ— æ•ˆæˆ–æ— æƒé™ï¼‰";
            else if (response.status === 403)
              errorMessage = "GitHub æƒé™ä¸è¶³ï¼ˆéœ€è¦ repo æƒé™ï¼‰";
            else if (response.status === 404)
              errorMessage = "ä»“åº“ä¸å­˜åœ¨æˆ–è·¯å¾„é”™è¯¯";
            else if (responseData.message)
              errorMessage += `: ${responseData.message}`;
            throw new Error(errorMessage);
          }
        } catch (error) {
          console.error("æäº¤å¤±è´¥:", error);
          showStatusMessage(`âŒ æäº¤å¤±è´¥: ${error.message}`, "error");
        } finally {
          updateButtonState(false, false);
        }
      }

      // åŠ è½½æ‰€æœ‰é…ç½®æ–‡ä»¶
      async function loadAllConfig() {
        try {
          const response = await fetch("config.conf");
          if (!response.ok) {
            throw new Error(
              `ä¸»é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥: ${response.status}ï¼ˆè¯·ç¡®ä¿ config.conf æ–‡ä»¶å­˜åœ¨ä¸”å¯è®¿é—®ï¼‰`
            );
          }

          const configText = await response.text();
          const configLines = configText.split("\n");

          configLines.forEach((line) => {
            if (line.trim() && !line.startsWith("#")) {
              const [key, value] = line.split("=").map((s) => s.trim());
              if (key && value) {
                if (["BASE_URL", "API_KEY", "MODEL"].includes(key)) {
                  AI_CONFIG[key] = value;
                } else if (key === "GITHUB_TOKEN") {
                  GITHUB_CONFIG.TOKEN = value;
                } else if (key === "REPO_OWNER") {
                  GITHUB_CONFIG.REPO_OWNER = value;
                } else if (key === "REPO_NAME") {
                  GITHUB_CONFIG.REPO_NAME = value;
                } else if (key === "GITHUB_API_URL" || key === "API_URL") {
                  GITHUB_CONFIG.API_URL = value;
                } else if (key === "PROMPT_FILE") {
                  AI_CONFIG.PROMPT_FILE = value;
                }
              }
            }
          });

          const missingAIConfigs = [];
          if (!AI_CONFIG.BASE_URL) missingAIConfigs.push("BASE_URL");
          if (!AI_CONFIG.API_KEY) missingAIConfigs.push("API_KEY");
          if (!AI_CONFIG.MODEL) missingAIConfigs.push("MODEL");

          if (missingAIConfigs.length > 0) {
            throw new Error(
              `AI é…ç½®ç¼ºå°‘: ${missingAIConfigs.join(
                ", "
              )}ï¼ˆè¯·æ£€æŸ¥ config.conf æ–‡ä»¶ï¼‰`
            );
          }

          const promptLoaded = await loadPromptFile();
          if (!promptLoaded) {
            console.warn("æç¤ºè¯æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨é»˜è®¤æç¤ºè¯");
          }

          AI_CONFIG.IS_CONFIGURED = true;

          if (!GITHUB_CONFIG.TOKEN) {
            const userToken = prompt(
              "è¯·æ‰‹åŠ¨è¾“å…¥ GitHub Personal Access Token:\n" +
                "ï¼ˆéœ€è¦ repo æƒé™ï¼Œä»…æœ¬åœ°ä½¿ç”¨ï¼Œä¸ä¼šä¸Šä¼ ï¼‰",
              ""
            );

            if (userToken && userToken.trim()) {
              GITHUB_CONFIG.TOKEN = userToken.trim();
              GITHUB_CONFIG.IS_CONFIGURED = true;
            } else {
              throw new Error("GitHub ä»¤ç‰Œæœªè®¾ç½®ï¼ˆæäº¤åŠŸèƒ½å°†æ— æ³•ä½¿ç”¨ï¼‰");
            }
          } else {
            GITHUB_CONFIG.IS_CONFIGURED = true;
          }

          showStatusMessage(
            `âœ… é…ç½®åŠ è½½æˆåŠŸï¼ä½¿ç”¨æ¨¡å‹: ${AI_CONFIG.MODEL}`,
            "success"
          );
          console.log("é…ç½®åŠ è½½æˆåŠŸ");
        } catch (error) {
          console.error("é…ç½®åŠ è½½é”™è¯¯:", error);
          showStatusMessage(`âš ï¸ é…ç½®åŠ è½½å¤±è´¥: ${error.message}`, "warning");
          convertBtn.disabled = true;
          submitBtn.disabled = true;
        }
      }

      // å¤„ç† TXT æ–‡ä»¶
      async function processTxtFiles(files) {
        if (!files || files.length === 0) return;

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        importTxtBtn.disabled = true;
        importTxtBtn.innerHTML =
          '<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin-slow"></div> å¯¼å…¥ä¸­...';

        let fileCount = files.length;
        let processedCount = 0;
        let newFiles = [];
        let combinedContent = "";

        showStatusMessage(`æ­£åœ¨å¯¼å…¥ ${fileCount} ä¸ªæ–‡ä»¶...`, "info");

        // ä¾æ¬¡è¯»å–æ–‡ä»¶
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (
            !file.name.toLowerCase().endsWith(".txt") &&
            !file.type.includes("text/plain")
          ) {
            showStatusMessage(`è·³è¿‡éæ–‡æœ¬æ–‡ä»¶: ${file.name}`, "warning");
            processedCount++;
            continue;
          }

          // æ£€æŸ¥æ˜¯å¦å·²å¯¼å…¥ç›¸åŒæ–‡ä»¶
          const isDuplicate = importedFiles.some(
            (f) => f.name === file.name && f.size === file.size
          );
          if (isDuplicate) {
            showStatusMessage(`è·³è¿‡é‡å¤æ–‡ä»¶: ${file.name}`, "warning");
            processedCount++;
            continue;
          }

          try {
            const content = await readFileAsText(file);
            newFiles.push({
              name: file.name,
              size: file.size,
              content: content,
            });
            // åˆå¹¶æ–‡ä»¶å†…å®¹ï¼ˆæ·»åŠ æ–‡ä»¶æ ‡è¯†ï¼‰
            combinedContent += `\n\n=== æ–‡ä»¶ ${file.name} ===\n\n${content}`;
            processedCount++;
            showStatusMessage(
              `å·²å¯¼å…¥ ${processedCount}/${fileCount} ä¸ªæ–‡ä»¶: ${file.name}`,
              "info"
            );
          } catch (error) {
            console.error(`è¯»å–æ–‡ä»¶å¤±è´¥ ${file.name}:`, error);
            showStatusMessage(
              `è¯»å–æ–‡ä»¶å¤±è´¥: ${file.name}ï¼ˆ${error.message}ï¼‰`,
              "error"
            );
          }
        }

        // æ·»åŠ æ–°æ–‡ä»¶åˆ°åˆ—è¡¨
        importedFiles = [...importedFiles, ...newFiles];
        // æ›´æ–°å¯¼å…¥å†…å®¹
        importedContent = combinedContent.trim();

        // æ›´æ–°æ–‡ä»¶åˆ—è¡¨å±•ç¤º
        updateFileList();

        // æç¤ºç»“æœ
        if (newFiles.length > 0) {
          showStatusMessage(
            `âœ… æˆåŠŸå¯¼å…¥ ${newFiles.length} ä¸ªæ–°æ–‡ä»¶`,
            "success"
          );
        } else {
          showStatusMessage("æ²¡æœ‰å¯¼å…¥æ–°çš„æœ‰æ•ˆæ–‡ä»¶", "warning");
        }

        // æ¢å¤æŒ‰é’®çŠ¶æ€
        importTxtBtn.disabled = false;
        importTxtBtn.innerHTML =
          '<i class="fas fa-file-import"></i> é€‰æ‹© TXT æ–‡ä»¶å¯¼å…¥';
      }

      // è¯»å–æ–‡ä»¶å†…å®¹
      function readFileAsText(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = () =>
            reject(new Error(`è¯»å–å¤±è´¥ï¼ˆæ–‡ä»¶ç¼–ç å¯èƒ½ä¸æ˜¯ UTF-8ï¼‰`));
          reader.readAsText(file, "UTF-8");
        });
      }

      // é¡µé¢åŠ è½½åˆå§‹åŒ–
      window.addEventListener("DOMContentLoaded", async () => {
        showStatusMessage("æ­£åœ¨åŠ è½½é…ç½®å’Œæç¤ºè¯...", "info");
        await loadAllConfig();
        initUIEvents();
        initCharCounts();
        updateFileList(); // åˆå§‹åŒ–æ–‡ä»¶åˆ—è¡¨
      });
    </script>
  </body>
</html>
