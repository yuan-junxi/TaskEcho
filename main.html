<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Issue æäº¤å·¥å…· - æœ¬åœ°æµ‹è¯•ç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f8fa;
            color: #24292e;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 30px;
            margin-top: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaecef;
        }

        h1 {
            color: #24292e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .github-icon {
            color: #24292e;
            font-size: 1.8rem;
        }

        .subtitle {
            color: #586069;
            font-size: 1.1rem;
        }

        .target-repo {
            background-color: #f6f8fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 4px solid #0366d6;
        }

        .target-repo h3 {
            margin-bottom: 8px;
            color: #0366d6;
        }

        .target-repo a {
            color: #0366d6;
            text-decoration: none;
            font-weight: 500;
        }

        .target-repo a:hover {
            text-decoration: underline;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #24292e;
        }

        .required {
            color: #d73a49;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            font-size: 16px;
            resize: vertical;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        textarea:focus {
            outline: none;
            border-color: #0366d6;
            box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.1);
        }

        textarea::placeholder {
            color: #a0a0a0;
        }

        #markdownOutput {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            background-color: #f8f9fa;
        }

        #markdownOutput:not([readonly]) {
            background-color: #ffffff;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 20px;
        }

        .button-group-left, .button-group-right {
            display: flex;
            gap: 15px;
        }

        button {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }

        #convertBtn {
            background-color: #0366d6;
            color: white;
        }

        #convertBtn:hover:not(:disabled) {
            background-color: #0256c7;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(3, 102, 214, 0.3);
        }

        #convertBtn:disabled {
            background-color: #79b8ff;
            cursor: not-allowed;
        }

        #submitBtn {
            background-color: #2ea44f;
            color: white;
        }

        #submitBtn:hover:not(:disabled) {
            background-color: #22863a;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(46, 164, 79, 0.3);
        }

        #submitBtn:disabled {
            background-color: #94d3a2;
            cursor: not-allowed;
        }

        #clearBtn {
            background-color: #fafbfc;
            color: #24292e;
            border: 1px solid #e1e4e8;
        }

        #clearBtn:hover {
            background-color: #f3f4f6;
            border-color: #d1d5da;
        }

        /* æ–‡ä»¶é€‰æ‹©è¾“å…¥æ¡†çš„éšè—æ ·å¼ */
        .file-input-hidden {
            display: none;
        }

        /* æŒ‰é’®æ‚¬åœæ•ˆæœ */
        #importTxtBtn {
            background-color: #6c757d;
            color: white;
        }

        #importTxtBtn:hover:not(:disabled) {
            background-color: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
        }

        #importTxtBtn:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }

        /* å¯¼å…¥ä¸­çš„æ ·å¼ */
        #importTxtBtn.importing {
            background-color: #6c757d;
            opacity: 0.8;
        }

        .status-message {
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            display: none;
            align-items: center;
            gap: 12px;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-icon {
            font-size: 1.2rem;
        }

        footer {
            margin-top: 30px;
            text-align: center;
            color: #586069;
            font-size: 0.9rem;
            padding-top: 20px;
            border-top: 1px solid #eaecef;
            width: 100%;
        }

        .note {
            background-color: #fff8e1;
            padding: 12px 15px;
            border-radius: 6px;
            margin-top: 20px;
            font-size: 0.9rem;
            border-left: 4px solid #ffd54f;
        }

        .note strong {
            color: #e65100;
        }

        .char-count {
            text-align: right;
            font-size: 0.9rem;
            color: #586069;
            margin-top: 5px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin-top: 10px;
            }

            .button-group {
                flex-direction: column;
                gap: 10px;
            }

            .button-group-left, .button-group-right {
                width: 100%;
                flex-direction: column;
            }

            button {
                width: 100%;
                padding: 12px 20px;
            }

            textarea {
                min-height: 150px;
                padding: 12px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.5rem;
                flex-direction: column;
                gap: 8px;
            }

            .subtitle {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
<header>
    <h1><i class="fab fa-github github-icon"></i> GitHub Issue æäº¤å·¥å…·</h1>
    <p class="subtitle">å°†æ‚¨çš„å†…å®¹ä½œä¸ºIssueæäº¤åˆ°æŒ‡å®šçš„GitHubä»“åº“</p>
</header>

<div class="container">
    <div class="target-repo">
        <h3>ç›®æ ‡ä»“åº“</h3>
        <p>æ‚¨çš„Issueå°†è¢«æäº¤åˆ°: <a href="https://github.com/yuan-junxi/TaskEcho/issues" target="_blank">https://github.com/yuan-junxi/TaskEcho/issues</a></p>
    </div>

    <div class="note">
        <strong>âš ï¸ é‡è¦å®‰å…¨è­¦å‘Šï¼š</strong>
        æ­¤æ–‡ä»¶ä»…é™æœ¬åœ°æµ‹è¯•ä½¿ç”¨ï¼æ–‡ä»¶ä¸­åŒ…å«æ‚¨çš„GitHubä»¤ç‰Œï¼Œè¯·å‹¿ä¸Šä¼ æˆ–åˆ†äº«æ­¤æ–‡ä»¶ã€‚æµ‹è¯•åè¯·ç«‹å³æ’¤é”€æ­¤ä»¤ç‰Œã€‚
    </div>

    <form id="issueForm">
        <div class="form-group">
            <label for="issueContent">Issueå†…å®¹ <span class="required">*</span></label>
            <textarea
                    id="issueContent"
                    placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„Issueå†…å®¹..."
                    required
            ></textarea>
            <div class="char-count">
                <span id="charCount">0</span> å­—ç¬¦
            </div>
        </div>

        <div class="form-group">
            <label for="issueTitle">Issueæ ‡é¢˜ <span class="required">*</span></label>
            <input
                    type="text"
                    id="issueTitle"
                    placeholder="è¯·è¾“å…¥Issueæ ‡é¢˜"
                    required
                    style="width: 100%; padding: 12px 15px; border: 1px solid #e1e4e8; border-radius: 6px; font-size: 16px; margin-bottom: 5px;"
            >
            <div class="char-count">
                <span id="titleCharCount">0</span> å­—ç¬¦
            </div>
        </div>

        <!-- åœ¨ç°æœ‰çš„è¡¨å•ä¸­ï¼Œåœ¨ Issueæ ‡é¢˜ è¾“å…¥æ¡†ä¹‹åæ·»åŠ  -->

        <div class="form-group">
            <label for="markdownOutput">AIç”Ÿæˆçš„Markdown <span class="required">*</span></label>
            <textarea
                    id="markdownOutput"
                    placeholder="ç‚¹å‡»"è½¬æ¢ä¸ºMarkdown"æŒ‰é’®åï¼ŒAIç”Ÿæˆçš„å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œã€‚æ‚¨å¯ä»¥ç¼–è¾‘æ­¤å†…å®¹ã€‚"
            readonly
            ></textarea>
            <div class="char-count">
                <span id="markdownCharCount">0</span> å­—ç¬¦
            </div>
        </div>

        <!-- æ›¿æ¢ç°æœ‰çš„æŒ‰é’®ç»„ -->
        <div class="button-group">
            <!-- åœ¨ç°æœ‰çš„æŒ‰é’®ç»„ä¸­ï¼Œåœ¨æ¸…ç©ºæŒ‰é’®åé¢æ·»åŠ  -->
            <div class="button-group-left">
                <button type="button" id="clearBtn">
                    <i class="fas fa-eraser"></i> æ¸…ç©ºå†…å®¹
                </button>
                <!-- æ·»åŠ è¿™ä¸ªæ–°æŒ‰é’® -->
                <button type="button" id="importTxtBtn">
                    <i class="fas fa-file-import"></i> å¯¼å…¥TXTæ–‡ä»¶
                </button>
                <button type="button" id="convertBtn">
                    <i class="fas fa-robot"></i> è½¬æ¢ä¸ºMarkdown
                </button>
            </div>
            <div class="button-group-right">
                <button type="submit" id="submitBtn">
                    <i class="fas fa-paper-plane"></i> æäº¤Issue
                </button>
            </div>
        </div>
    </form>

    <div id="statusMessage" class="status-message">
        <i class="fas fa-info-circle status-icon"></i>
        <span id="statusText">çŠ¶æ€ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</span>
    </div>
</div>

<footer>
    <p>Â© 2023 GitHub Issueæäº¤å·¥å…· | æ­¤å·¥å…·ä½¿ç”¨GitHub REST API | ä»…é™æœ¬åœ°æµ‹è¯•</p>
</footer>


<script>
    // è·å–DOMå…ƒç´ 
    const issueForm = document.getElementById('issueForm');
    const issueContent = document.getElementById('issueContent');
    const issueTitle = document.getElementById('issueTitle');
    const markdownOutput = document.getElementById('markdownOutput');
    const submitBtn = document.getElementById('submitBtn');
    const convertBtn = document.getElementById('convertBtn');
    const clearBtn = document.getElementById('clearBtn');
    const statusMessage = document.getElementById('statusMessage');
    const statusText = document.getElementById('statusText');
    const charCount = document.getElementById('charCount');
    const titleCharCount = document.getElementById('titleCharCount');
    const markdownCharCount = document.getElementById('markdownCharCount');
    // è·å–DOMå…ƒç´ ï¼ˆæ·»åŠ è¿™ä¸€è¡Œï¼‰
    const importTxtBtn = document.getElementById('importTxtBtn');

    // é…ç½®å˜é‡
    let AI_CONFIG = {
        BASE_URL: '',
        API_KEY: '',
        MODEL: '',
        PROMPT_FILE: 'prompt.txt',
        PROMPT_CONTENT: '',
        IS_CONFIGURED: false
    };

    let GITHUB_CONFIG = {
        TOKEN: '',
        REPO_OWNER: 'yuan-junxi',
        REPO_NAME: 'TaskEcho',
        API_URL: 'https://api.github.com',
        IS_CONFIGURED: false
    };

    // åˆå§‹åŒ–DOMäº‹ä»¶
    function initUIEvents() {
        // å­—ç¬¦è®¡æ•°æ›´æ–°
        issueContent.addEventListener('input', () => {
            charCount.textContent = issueContent.value.length;
        });

        issueTitle.addEventListener('input', () => {
            titleCharCount.textContent = issueTitle.value.length;
        });

        markdownOutput.addEventListener('input', () => {
            markdownCharCount.textContent = markdownOutput.value.length;
        });

        // æ–‡ä»¶å¯¼å…¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        importTxtBtn.addEventListener('click', () => {
            // åˆ›å»ºéšè—çš„æ–‡ä»¶è¾“å…¥æ¡†
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.txt,text/plain';
            fileInput.multiple = true; // å…è®¸å¤šé€‰
            fileInput.className = 'file-input-hidden';

            // æ–‡ä»¶é€‰æ‹©åçš„å¤„ç†
            fileInput.addEventListener('change', async (e) => {
                const files = e.target.files;
                if (files.length === 0) return;

                await processTxtFiles(files);

                // ç§»é™¤ä¸´æ—¶æ–‡ä»¶è¾“å…¥æ¡†
                fileInput.remove();
            });

            // è§¦å‘æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
            document.body.appendChild(fileInput);
            fileInput.click();
        });

        // æ¸…ç©ºè¡¨å•
        clearBtn.addEventListener('click', () => {
            issueContent.value = '';
            issueTitle.value = '';
            markdownOutput.value = '';
            charCount.textContent = '0';
            titleCharCount.textContent = '0';
            markdownCharCount.textContent = '0';
            markdownOutput.readOnly = true;
            markdownOutput.style.backgroundColor = '#f8f9fa';
            hideStatusMessage();

        });

        // è½¬æ¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        convertBtn.addEventListener('click', async () => {
            await convertToMarkdown();
        });

        // æäº¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        issueForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await submitIssue();
        });
    }

    // åˆå§‹åŒ–å­—ç¬¦è®¡æ•°
    function initCharCounts() {
        charCount.textContent = issueContent.value.length;
        titleCharCount.textContent = issueTitle.value.length;
        markdownCharCount.textContent = markdownOutput.value.length;
    }

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatusMessage(message, type) {
        statusText.textContent = message;
        statusMessage.className = `status-message ${type}`;
        statusMessage.style.display = 'flex';
    }

    // éšè—çŠ¶æ€æ¶ˆæ¯
    function hideStatusMessage() {
        statusMessage.style.display = 'none';
    }

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    function updateButtonState(converting = false, submitting = false) {
        convertBtn.disabled = converting || submitting;
        submitBtn.disabled = submitting || converting;

        if (converting) {
            convertBtn.innerHTML = '<div class="loading"></div> è½¬æ¢ä¸­...';
        } else {
            convertBtn.innerHTML = '<i class="fas fa-robot"></i> è½¬æ¢ä¸ºMarkdown';
        }

        if (submitting) {
            submitBtn.innerHTML = '<div class="loading"></div> æäº¤ä¸­...';
        } else {
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> æäº¤Issue';
        }
    }

    // éªŒè¯è¡¨å•
    function validateForm() {
        if (!issueTitle.value.trim()) {
            showStatusMessage('è¯·å¡«å†™Issueæ ‡é¢˜', 'error');
            issueTitle.focus();
            return false;
        }

        if (!issueContent.value.trim()) {
            showStatusMessage('è¯·å¡«å†™Issueå†…å®¹', 'error');
            issueContent.focus();
            return false;
        }

        if (!markdownOutput.value.trim()) {
            showStatusMessage('è¯·å…ˆè½¬æ¢Markdownå†…å®¹', 'error');
            convertBtn.focus();
            return false;
        }

        return true;
    }

    // åŠ è½½æç¤ºè¯æ–‡ä»¶
    async function loadPromptFile() {
        try {
            const response = await fetch(AI_CONFIG.PROMPT_FILE);
            if (!response.ok) {
                console.warn(`æç¤ºè¯æ–‡ä»¶åŠ è½½å¤±è´¥: ${response.status}ï¼Œä½¿ç”¨å†…ç½®æç¤ºè¯`);
                AI_CONFIG.PROMPT_CONTENT = `è¯·å°†ä»¥ä¸‹ç”¨æˆ·è¾“å…¥çš„å†…å®¹ï¼Œä¼˜åŒ–å¹¶æ ¼å¼åŒ–ä¸ºä¸€ä¸ªç»“æ„æ¸…æ™°ã€é€‚åˆä½œä¸ºGitHub Issueæè¿°çš„Markdownæ–‡æœ¬ã€‚è¦æ±‚ï¼š
1. ä¿æŒåŸæ„ä¸å˜ï¼Œä¼˜åŒ–è¯­è¨€è¡¨è¾¾
2. ä½¿ç”¨åˆé€‚çš„Markdownæ ¼å¼ï¼ˆå¦‚æ ‡é¢˜ã€åˆ—è¡¨ã€ä»£ç å—ç­‰ï¼‰
3. å¦‚æœå†…å®¹æ¶‰åŠé—®é¢˜æè¿°ï¼Œè¯·ç»“æ„åŒ–ç»„ç»‡
4. è¾“å‡ºè¯­è¨€ä¸è¾“å…¥è¯­è¨€ä¿æŒä¸€è‡´

ç”¨æˆ·è¾“å…¥å†…å®¹ï¼š`;
                return true;
            }

            const promptText = await response.text();
            if (!promptText.trim()) {
                throw new Error('æç¤ºè¯æ–‡ä»¶ä¸ºç©º');
            }

            AI_CONFIG.PROMPT_CONTENT = promptText;
            console.log('æç¤ºè¯æ–‡ä»¶åŠ è½½æˆåŠŸï¼Œé•¿åº¦:', promptText.length);
            return true;

        } catch (error) {
            console.error('åŠ è½½æç¤ºè¯æ–‡ä»¶å¤±è´¥:', error);
            AI_CONFIG.PROMPT_CONTENT = `è¯·å°†ä»¥ä¸‹æ–‡æœ¬è½¬æ¢ä¸ºæ ¼å¼è‰¯å¥½çš„GitHub Issue Markdownæè¿°ï¼š

ç”¨æˆ·è¾“å…¥ï¼š`;
            return true;
        }
    }

    // æ„å»ºå®Œæ•´æç¤ºè¯
    function buildFullPrompt(originalText) {
        let fullPrompt = AI_CONFIG.PROMPT_CONTENT;

        if (!fullPrompt.endsWith('\n')) {
            fullPrompt += '\n';
        }

        if (!fullPrompt.includes('ç”¨æˆ·è¾“å…¥ï¼š') && !fullPrompt.includes('User Input:')) {
            fullPrompt += '\n---\nç”¨æˆ·è¾“å…¥ï¼š\n';
        }

        fullPrompt += originalText;

        return fullPrompt;
    }

    // æ£€æµ‹APIæä¾›å•†ç±»å‹
    function detectAPIProvider(baseUrl) {
        const url = baseUrl.toLowerCase();

        const providerPatterns = [
            { pattern: 'openai|api.openai.com', provider: 'openai' },
            { pattern: 'anthropic|api.anthropic.com', provider: 'anthropic' },
            { pattern: 'deepseek|api.deepseek.com', provider: 'deepseek' },
            { pattern: 'ollama|localhost|127.0.0.1', provider: 'ollama' },
            { pattern: 'groq|api.groq.com', provider: 'groq' },
            { pattern: 'zhipu|open.bigmodel.cn', provider: 'zhipu' },
            { pattern: 'qwen|dashscope.aliyuncs.com', provider: 'qwen' },
            { pattern: 'azure|openai.azure.com', provider: 'azure' }
        ];

        for (const { pattern, provider } of providerPatterns) {
            if (new RegExp(pattern).test(url)) {
                return provider;
            }
        }

        return 'openai-compatible';
    }

    // æ„å»ºå¯¹åº”APIæä¾›å•†çš„è¯·æ±‚å‚æ•°
    function buildAIRequest(provider, fullPrompt) {
        const commonParams = {
            model: AI_CONFIG.MODEL,
            max_tokens: 4000,
            temperature: 0.3
        };

        switch(provider) {
            case 'openai':
            case 'deepseek':
            case 'groq':
            case 'azure':
            case 'openai-compatible':
                return {
                    url: `${AI_CONFIG.BASE_URL}/chat/completions`,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AI_CONFIG.API_KEY}`
                    },
                    body: JSON.stringify({
                        ...commonParams,
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€åä¸“ä¸šçš„Markdownæ ¼å¼åŒ–åŠ©æ‰‹ï¼Œä¸“æ³¨äºå°†æ–‡æœ¬è½¬æ¢ä¸ºç»“æ„è‰¯å¥½çš„GitHub Issueæè¿°ã€‚'
                            },
                            { role: 'user', content: fullPrompt }
                        ],
                        stream: false
                    })
                };

            case 'anthropic':
                return {
                    url: `${AI_CONFIG.BASE_URL}/v1/messages`,
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': AI_CONFIG.API_KEY,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: AI_CONFIG.MODEL,
                        max_tokens: 4000,
                        messages: [
                            { role: 'user', content: fullPrompt }
                        ],
                        system: 'ä½ æ˜¯ä¸€åä¸“ä¸šçš„Markdownæ ¼å¼åŒ–åŠ©æ‰‹ï¼Œä¸“æ³¨äºå°†æ–‡æœ¬è½¬æ¢ä¸ºç»“æ„è‰¯å¥½çš„GitHub Issueæè¿°ã€‚'
                    })
                };

            case 'ollama':
                return {
                    url: `${AI_CONFIG.BASE_URL}/api/chat`,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: AI_CONFIG.MODEL,
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€åä¸“ä¸šçš„Markdownæ ¼å¼åŒ–åŠ©æ‰‹ï¼Œä¸“æ³¨äºå°†æ–‡æœ¬è½¬æ¢ä¸ºç»“æ„è‰¯å¥½çš„GitHub Issueæè¿°ã€‚'
                            },
                            { role: 'user', content: fullPrompt }
                        ],
                        stream: false,
                        options: {
                            temperature: 0.3,
                            num_predict: 4000
                        }
                    })
                };

            case 'zhipu':
                return {
                    url: `${AI_CONFIG.BASE_URL}/chat/completions`,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AI_CONFIG.API_KEY}`
                    },
                    body: JSON.stringify({
                        model: AI_CONFIG.MODEL,
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€åä¸“ä¸šçš„Markdownæ ¼å¼åŒ–åŠ©æ‰‹ï¼Œä¸“æ³¨äºå°†æ–‡æœ¬è½¬æ¢ä¸ºç»“æ„è‰¯å¥½çš„GitHub Issueæè¿°ã€‚'
                            },
                            { role: 'user', content: fullPrompt }
                        ],
                        temperature: 0.3,
                        max_tokens: 4000
                    })
                };

            case 'qwen':
                return {
                    url: `${AI_CONFIG.BASE_URL}/api/v1/services/aigc/text-generation/generation`,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AI_CONFIG.API_KEY}`
                    },
                    body: JSON.stringify({
                        model: AI_CONFIG.MODEL,
                        input: {
                            messages: [
                                {
                                    role: 'system',
                                    content: 'ä½ æ˜¯ä¸€åä¸“ä¸šçš„Markdownæ ¼å¼åŒ–åŠ©æ‰‹ï¼Œä¸“æ³¨äºå°†æ–‡æœ¬è½¬æ¢ä¸ºç»“æ„è‰¯å¥½çš„GitHub Issueæè¿°ã€‚'
                                },
                                { role: 'user', content: fullPrompt }
                            ]
                        },
                        parameters: {
                            temperature: 0.3,
                            max_tokens: 4000
                        }
                    })
                };

            default:
                return {
                    url: `${AI_CONFIG.BASE_URL}/chat/completions`,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AI_CONFIG.API_KEY}`
                    },
                    body: JSON.stringify({
                        ...commonParams,
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€åä¸“ä¸šçš„Markdownæ ¼å¼åŒ–åŠ©æ‰‹ï¼Œä¸“æ³¨äºå°†æ–‡æœ¬è½¬æ¢ä¸ºç»“æ„è‰¯å¥½çš„GitHub Issueæè¿°ã€‚'
                            },
                            { role: 'user', content: fullPrompt }
                        ],
                        stream: false
                    })
                };
        }
    }

    // è§£æä¸åŒAPIçš„å“åº”
    function parseAIResponse(provider, data) {
        try {
            let content = '';

            switch(provider) {
                case 'openai':
                case 'deepseek':
                case 'groq':
                case 'azure':
                case 'openai-compatible':
                case 'zhipu':
                    content = data.choices[0]?.message?.content || '';
                    break;

                case 'anthropic':
                    content = data.content[0]?.text || '';
                    break;

                case 'ollama':
                    content = data.message?.content || '';
                    break;

                case 'qwen':
                    content = data.output?.text || data.output?.choices?.[0]?.message?.content || '';
                    break;

                default:
                    if (data.choices && data.choices[0]?.message?.content) {
                        content = data.choices[0].message.content;
                    } else if (data.content) {
                        content = data.content;
                    } else if (data.message) {
                        content = data.message.content || data.message;
                    } else if (data.output) {
                        content = data.output.text || JSON.stringify(data.output);
                    }
            }

            content = content.trim();

            const unwantedPrefixes = [
                'å¥½çš„ï¼Œ',
                'ä»¥ä¸‹æ˜¯',
                'æ ¹æ®æ‚¨çš„è¦æ±‚',
                'æ ¹æ®ç”¨æˆ·è¾“å…¥',
                'è½¬æ¢åçš„Markdownå¦‚ä¸‹ï¼š',
                'Markdownæ ¼å¼ï¼š'
            ];

            for (const prefix of unwantedPrefixes) {
                if (content.startsWith(prefix)) {
                    content = content.substring(prefix.length).trim();
                }
            }

            return content;

        } catch (error) {
            console.error('è§£æAIå“åº”å¤±è´¥:', error, data);
            return '';
        }
    }

    // è½¬æ¢ä¸ºMarkdown
    async function convertToMarkdown() {
        const title = issueTitle.value.trim();
        const body = issueContent.value.trim();

        if (!AI_CONFIG.IS_CONFIGURED) {
            showStatusMessage('âŒ AIé…ç½®æœªåŠ è½½å®Œæˆ', 'error');
            return;
        }

        if (!title) {
            showStatusMessage('è¯·å…ˆå¡«å†™Issueæ ‡é¢˜', 'error');
            issueTitle.focus();
            return;
        }

        if (!body) {
            showStatusMessage('è¯·å…ˆå¡«å†™Issueå†…å®¹', 'error');
            issueContent.focus();
            return;
        }

        updateButtonState(true, false);
        showStatusMessage(`ğŸ¤– æ­£åœ¨ä½¿ç”¨ ${AI_CONFIG.MODEL} è½¬æ¢Markdown...`, 'info');

        try {
            const fullPrompt = buildFullPrompt(body);
            const provider = detectAPIProvider(AI_CONFIG.BASE_URL);
            const requestConfig = buildAIRequest(provider, fullPrompt);

            const response = await fetch(requestConfig.url, {
                method: 'POST',
                headers: requestConfig.headers,
                body: requestConfig.body
            });

            if (!response.ok) {
                let errorMessage = `AI APIé”™è¯¯ (${response.status})`;
                try {
                    const errorData = await response.json();
                    errorMessage += `: ${errorData.error?.message || JSON.stringify(errorData)}`;
                } catch (e) {
                    errorMessage += `: ${response.statusText}`;
                }
                throw new Error(errorMessage);
            }

            const data = await response.json();
            const formattedText = parseAIResponse(provider, data);

            if (!formattedText.trim()) {
                throw new Error('AIè¿”å›å†…å®¹ä¸ºç©º');
            }

            // å°†ç»“æœå¡«å…¥è¾“å‡ºæ¡†ï¼Œå¹¶å…è®¸ç¼–è¾‘
            markdownOutput.value = formattedText;
            markdownOutput.readOnly = false;
            markdownOutput.style.backgroundColor = '#ffffff';
            markdownCharCount.textContent = formattedText.length;

            showStatusMessage(`âœ… ${AI_CONFIG.MODEL} è½¬æ¢å®Œæˆï¼å¯ä»¥ç¼–è¾‘Markdownå†…å®¹`, 'success');

        } catch (error) {
            console.error('AIè½¬æ¢å¤±è´¥:', error);
            showStatusMessage(`âš ï¸ AIè½¬æ¢å¤±è´¥: ${error.message}`, 'error');
        } finally {
            updateButtonState(false, false);
        }
    }

    // æäº¤Issueåˆ°GitHub
    async function submitIssue() {
        if (!GITHUB_CONFIG.IS_CONFIGURED) {
            showStatusMessage('âŒ GitHubé…ç½®æœªåŠ è½½å®Œæˆ', 'error');
            return;
        }

        if (!validateForm()) {
            return;
        }

        const title = issueTitle.value.trim();
        const body = markdownOutput.value.trim();

        updateButtonState(false, true);
        showStatusMessage('ğŸš€ æ­£åœ¨æäº¤Issueåˆ°GitHub...', 'info');

        try {
            const apiUrl = `${GITHUB_CONFIG.API_URL}/repos/${GITHUB_CONFIG.REPO_OWNER}/${GITHUB_CONFIG.REPO_NAME}/issues`;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `token ${GITHUB_CONFIG.TOKEN}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                    title: title,
                    body: body
                })
            });

            const responseData = await response.json();

            if (response.ok) {
                showStatusMessage(`âœ… Issue #${responseData.number} åˆ›å»ºæˆåŠŸï¼`, 'success');

                // æ¸…ç©ºè¡¨å•ï¼Œä½†ä¿ç•™æ ‡é¢˜å’Œå†…å®¹æ–¹ä¾¿ç»§ç»­ç¼–è¾‘
                markdownOutput.value = '';
                markdownOutput.readOnly = true;
                markdownOutput.style.backgroundColor = '#f8f9fa';
                markdownCharCount.textContent = '0';

                setTimeout(() => {
                    if (responseData.html_url) {
                        window.open(responseData.html_url, '_blank');
                    }
                }, 1500);

            } else {
                let errorMessage = `GitHubæäº¤å¤±è´¥ (${response.status})`;
                if (response.status === 401) errorMessage = 'GitHubè®¤è¯å¤±è´¥';
                else if (response.status === 403) errorMessage = 'GitHubæƒé™ä¸è¶³';
                else if (response.status === 404) errorMessage = 'ä»“åº“ä¸å­˜åœ¨';
                else if (responseData.message) errorMessage += `: ${responseData.message}`;
                throw new Error(errorMessage);
            }

        } catch (error) {
            console.error('æäº¤å¤±è´¥:', error);
            showStatusMessage(`æäº¤å¤±è´¥: ${error.message}`, 'error');
        } finally {
            updateButtonState(false, false);
        }
    }

    // åŠ è½½æ‰€æœ‰é…ç½®æ–‡ä»¶
    async function loadAllConfig() {
        try {
            const response = await fetch('config.conf');
            if (!response.ok) {
                throw new Error(`ä¸»é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥: ${response.status}`);
            }

            const configText = await response.text();
            const configLines = configText.split('\n');

            configLines.forEach(line => {
                if (line.trim() && !line.startsWith('#')) {
                    const [key, value] = line.split('=').map(s => s.trim());
                    if (key && value) {
                        if (['BASE_URL', 'API_KEY', 'MODEL'].includes(key)) {
                            AI_CONFIG[key] = value;
                        }
                        else if (key === 'GITHUB_TOKEN') {
                            GITHUB_CONFIG.TOKEN = value;
                        } else if (key === 'REPO_OWNER') {
                            GITHUB_CONFIG.REPO_OWNER = value;
                        } else if (key === 'REPO_NAME') {
                            GITHUB_CONFIG.REPO_NAME = value;
                        } else if (key === 'GITHUB_API_URL') {
                            GITHUB_CONFIG.API_URL = value;
                        } else if (key === 'API_URL') {
                            GITHUB_CONFIG.API_URL = value;
                        }
                        else if (key === 'PROMPT_FILE') {
                            AI_CONFIG.PROMPT_FILE = value;
                        }
                    }
                }
            });

            const missingAIConfigs = [];
            if (!AI_CONFIG.BASE_URL) missingAIConfigs.push('BASE_URL');
            if (!AI_CONFIG.API_KEY) missingAIConfigs.push('API_KEY');
            if (!AI_CONFIG.MODEL) missingAIConfigs.push('MODEL');

            if (missingAIConfigs.length > 0) {
                throw new Error(`AIé…ç½®ç¼ºå°‘: ${missingAIConfigs.join(', ')}`);
            }

            const promptLoaded = await loadPromptFile();
            if (!promptLoaded) {
                console.warn('æç¤ºè¯æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨é»˜è®¤æç¤ºè¯');
            }

            AI_CONFIG.IS_CONFIGURED = true;

            if (!GITHUB_CONFIG.TOKEN) {
                const userToken = prompt(
                    'è¯·æ‰‹åŠ¨è¾“å…¥GitHub Personal Access Token:\n' +
                    'ï¼ˆéœ€è¦repoæƒé™ï¼Œä»…æœ¬åœ°ä½¿ç”¨ï¼‰',
                    ''
                );

                if (userToken && userToken.trim()) {
                    GITHUB_CONFIG.TOKEN = userToken.trim();
                    GITHUB_CONFIG.IS_CONFIGURED = true;
                } else {
                    throw new Error('GitHubä»¤ç‰Œæœªè®¾ç½®');
                }
            } else {
                GITHUB_CONFIG.IS_CONFIGURED = true;
            }

            showStatusMessage(`âœ… é…ç½®åŠ è½½æˆåŠŸï¼ä½¿ç”¨æ¨¡å‹: ${AI_CONFIG.MODEL}`, 'info');
            console.log('é…ç½®åŠ è½½æˆåŠŸ');

        } catch (error) {
            console.error('é…ç½®åŠ è½½é”™è¯¯:', error);
            showStatusMessage(`âš ï¸ é…ç½®åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            convertBtn.disabled = true;
            submitBtn.disabled = true;
        }
    }

    // å¤„ç†å¤šä¸ªTXTæ–‡ä»¶
    async function processTxtFiles(files) {
        if (!files || files.length === 0) return;

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        importTxtBtn.disabled = true;
        importTxtBtn.classList.add('importing');
        importTxtBtn.innerHTML = '<div class="loading"></div> å¯¼å…¥ä¸­...';

        let allContent = '';
        let fileCount = files.length;
        let processedCount = 0;

        showStatusMessage(`æ­£åœ¨å¯¼å…¥ ${fileCount} ä¸ªæ–‡ä»¶...`, 'info');

        // ä¾æ¬¡è¯»å–æ¯ä¸ªæ–‡ä»¶
        for (let i = 0; i < files.length; i++) {
            const file = files[i];

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.name.toLowerCase().endsWith('.txt') &&
                !file.type.includes('text/plain')) {
                showStatusMessage(`è·³è¿‡éæ–‡æœ¬æ–‡ä»¶: ${file.name}`, 'error');
                processedCount++;
                continue;
            }

            try {
                const content = await readFileAsText(file);
                allContent += `\n\n=== æ–‡ä»¶ ${i + 1}: ${file.name} ===\n\n`;
                allContent += content;
                processedCount++;

                // æ›´æ–°è¿›åº¦
                showStatusMessage(`å·²å¯¼å…¥ ${processedCount}/${fileCount} ä¸ªæ–‡ä»¶: ${file.name}`, 'info');
            } catch (error) {
                console.error(`è¯»å–æ–‡ä»¶å¤±è´¥ ${file.name}:`, error);
                showStatusMessage(`è¯»å–æ–‡ä»¶å¤±è´¥: ${file.name}`, 'error');
            }
        }

        // åˆå¹¶å†…å®¹åˆ°æ–‡æœ¬æ¡†
        if (allContent.trim()) {
            // å¦‚æœå½“å‰æ–‡æœ¬æ¡†æœ‰å†…å®¹ï¼Œæ·»åŠ åˆ†éš”ç¬¦
            const currentContent = issueContent.value.trim();
            if (currentContent) {
                issueContent.value = currentContent + '\n\n' + '--- å¯¼å…¥çš„æ–‡ä»¶å†…å®¹ ---' + allContent;
            } else {
                issueContent.value = allContent.trim();
            }

            // æ›´æ–°å­—ç¬¦è®¡æ•°
            charCount.textContent = issueContent.value.length;

            showStatusMessage(`âœ… æˆåŠŸå¯¼å…¥ ${processedCount} ä¸ªæ–‡ä»¶ï¼Œå…± ${allContent.length} å­—ç¬¦`, 'success');
        } else {
            showStatusMessage('æ²¡æœ‰æˆåŠŸå¯¼å…¥ä»»ä½•å†…å®¹', 'error');
        }

        // æ¢å¤æŒ‰é’®çŠ¶æ€
        importTxtBtn.disabled = false;
        importTxtBtn.classList.remove('importing');
        importTxtBtn.innerHTML = '<i class="fas fa-file-import"></i> å¯¼å…¥TXTæ–‡ä»¶';
    }

    // è¯»å–æ–‡ä»¶å†…å®¹
    function readFileAsText(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();

            reader.onload = (e) => {
                resolve(e.target.result);
            };

            reader.onerror = (e) => {
                reject(new Error(`è¯»å–æ–‡ä»¶å¤±è´¥: ${file.name}`));
            };

            reader.readAsText(file, 'UTF-8');
        });
    }

    // é¡µé¢åŠ è½½
    window.addEventListener('DOMContentLoaded', async () => {
        showStatusMessage('æ­£åœ¨åŠ è½½é…ç½®å’Œæç¤ºè¯...', 'info');
        await loadAllConfig();
        initUIEvents();
        initCharCounts();
    });
</script>


</body>
</html>